# Unified Make.com Scenario Blueprint

This document provides a complete reference for the unified client journey automation scenario in Make.com.

## Scenario Overview

**Name**: Unified Client Journey Automation
**Type**: Custom Webhook Trigger (Instant)
**Database**: Notion Leads Database
**Routes**: 7 (covering all status transitions)

## Architecture

```
Notion Database (Status Changes)
    ↓
Polling Service (/api/poll/notion) - Runs every 5-10 seconds
    ↓
Detects Status Changes
    ↓
Forwards to Make.com Custom Webhook
    ↓
Unified Automation Scenario (7 Routes)
```

## Complete Module Structure

### Module 1: Custom Webhook Trigger

**IMPORTANT**: Make.com's Notion "Watch Database Items" does NOT support instant webhooks. We use a custom webhook solution instead.

```
Module Type: Webhooks > Custom webhook
Webhook URL: [Generated by Make.com - copy this URL]
Method: POST
Data Structure: JSON
```

**Setup Steps:**

1. **In Make.com, create a new scenario**
2. **Add Module**: Click "+" and search for "Webhooks"
3. **Select**: **"Custom webhook (INSTANT)"** - This is the trigger that receives data
   - ⚠️ **NOT** "Custom mailhook" (that's for email)
   - ⚠️ **NOT** "Webhook response" (that's for responding to webhooks)
   - ✅ **YES** "Custom webhook (INSTANT)" - Triggers when webhook receives data
4. **Copy the webhook URL** - You'll need this for the polling service
5. **Save the scenario** - The webhook URL is now active

**Webhook Payload Structure** (sent by polling service):
```json
{
  "id": "page-id-here",
  "database_id": "ce12e087-e701-4902-ae70-8ff582981d1b",
  "status": "Qualified",
  "properties": { /* Full Notion page properties */ },
  "url": "https://notion.so/...",
  "triggered_at": "2026-01-25T12:00:00.000Z"
}
```

**Output Variables** (mapped from webhook payload):
- `{{1.id}}` or `{{1.data.id}}` - Page ID
- `{{1.status}}` or `{{1.data.status}}` - Status value (e.g., "Qualified")
- `{{1.properties.Name[0].plain_text}}` or `{{1.data.properties.Name[0].plain_text}}` - Client name
- `{{1.properties.Email}}` or `{{1.data.properties.Email}}` - Email
- `{{1.properties.Company[0].plain_text}}` or `{{1.data.properties.Company[0].plain_text}}` - Company

**Note**: The exact path depends on how Make.com structures the webhook data. Check the webhook execution data to see the exact structure.

### Polling Service Setup

The polling service at `/api/poll/notion` needs to be called every 5-10 seconds. Options:

**Option A: External Cron Service** (Recommended - Required for Hobby plan)
- ⚠️ **Vercel Hobby plan limitation**: Only supports daily cron jobs (once per day)
- Use an external cron service for frequent polling:
  - **cron-job.org** (Free tier available)
  - **EasyCron** (Paid, but reliable)
  - **UptimeRobot** (Free tier available)
- Set to call: `https://zynra.studio/api/poll/notion` every 10 seconds
- These services support second-level precision
- **Setup example for cron-job.org**:
  1. Sign up at https://cron-job.org
  2. Create new cron job
  3. URL: `https://zynra.studio/api/poll/notion`
  4. Schedule: Every 10 seconds (or use custom: `*/10 * * * * *`)
  5. Method: GET
  6. Save and activate

**Option B: Make.com HTTP Module Loop** (Alternative)
- Create a separate Make.com scenario that calls the polling endpoint
- Use "Schedule" trigger to run every 10 seconds
- Add HTTP module to call: `https://zynra.studio/api/poll/notion`

**Option C: Vercel Cron Jobs** (Pro plan only)
- ⚠️ **Requires Vercel Pro plan** - Hobby plan only allows daily cron jobs
- If you upgrade to Pro, you can use `vercel.json` with schedule: `*/1 * * * *`

**Environment Variables Required:**
```bash
NOTION_API_KEY=your_notion_api_key
NOTION_LEADS_DATABASE_ID=ce12e087-e701-4902-ae70-8ff582981d1b
MAKE_WEBHOOK_URL=your_make_webhook_url_from_module_1
MAKE_WEBHOOK_API_KEY=your_api_key_here  # Optional: Only if you enabled API key authentication
```

**Webhook Configuration:**
- **Webhook name**: `Notion Status Change Webhook` (or any descriptive name)
- **API Key authentication**: Recommended for security
  - Generate a secure random API key in Make.com
  - Add it to `MAKE_WEBHOOK_API_KEY` environment variable
  - The polling service will automatically include it in the `x-make-apikey` header

---

### Module 2: Router

```
Module Type: Flow Control - Router
Routes: 7 (see below)
```

---

## Route 1: Qualified → Welcome Email

### Filter Configuration
```
Label: Qualified → Welcome Email
Condition: 1. Status = "Qualified" OR 1. data.status = "Qualified"
Fallback: No
```

**Note**: The exact field path depends on Make.com's webhook data structure. Check the webhook execution to see if it's `{{1.status}}` or `{{1.data.status}}`.

### Module 3A: HTTP - Generate Welcome Email
```
Method: POST
URL: https://zynra.studio/api/generate-welcome-email
Headers:
  - Content-Type: application/json
Body Type: Raw
Content Type: JSON
Body:
{
  "templatePageId": "2ee13f3ae6f38117b3eef77f98ce06c2",
  "leadData": {
    "name": "{{1.properties.Name[0].plain_text}}",
    "email": "{{1.properties.Email.email}}",
    "service": "{{1.properties.Service.select.name}}",
    "company": "{{1.properties.Company[0].plain_text}}",
    "budgetRange": "{{1.properties.BudgetRange.select.name}}",
    "timeline": "{{1.properties.Timeline.select.name}}",
    "message": "{{1.properties.Message[0].plain_text}}",
    "schedulingLink": "https://cal.com/zynra.studio"
  }
}
```

**Note**: Adjust property paths based on actual webhook data structure. Use Make.com's data mapper or check execution history for exact paths.

### Module 4A: Email - Create Draft
```
Module Type: Google Email - Create a Draft
Connection: [Your Email Connection]
Folder: / Drafts
To: {{1.properties_value.Email}}
Subject: {{3.Body.subject}}
Content Type: HTML
Content: {{3.Body.html}}
```

### Module 5A: Notion - Update Record
```
Module Type: Notion - Update a Data Source Item
Connection: [Your Notion Connection]
Update By: Data Source
Data Source ID: ce12e087-e701-4902-ae70-8ff582981d1b
Page ID: {{1.id}}
Fields:
  - Email Draft Created: true (Checkbox)
  - Draft Email ID: {{4.id}} (Text)
```

---

## Route 2: Unqualified → Rejection Email

### Filter Configuration
```
Label: Unqualified → Rejection Email
Condition: 1. Status = "Unqualified" OR 1. data.status = "Unqualified"
Fallback: No
```

### Module 3B: HTTP - Generate Rejection Email
```
Method: POST
URL: https://zynra.studio/api/generate-rejection-email
Headers:
  - Content-Type: application/json
Body Type: Raw
Content Type: JSON
Body:
{
  "templatePageId": "2ee13f3ae6f381cca68ae4b059d8eda5",
  "leadData": {
    "name": "{{1.properties_value.Name[1].plain_text}}",
    "email": "{{1.properties_value.Email}}",
    "rejectionReason": "{{1.properties_value.Rejection Reason[1].plain_text}}"
  }
}
```

### Module 4B: Email - Create Draft
```
Module Type: Google Email - Create a Draft
Connection: [Your Email Connection]
Folder: / Drafts
To: {{1.properties_value.Email}}
Subject: {{3.Body.subject}}
Content Type: HTML
Content: {{3.Body.html}}
```

### Module 5B: Notion - Update Record
```
Module Type: Notion - Update a Data Source Item
Connection: [Your Notion Connection]
Update By: Data Source
Data Source ID: ce12e087-e701-4902-ae70-8ff582981d1b
Page ID: {{1.id}}
Fields:
  - Email Draft Created: true (Checkbox)
  - Draft Email ID: {{4.id}} (Text)
```

---

## Route 3: Discovery Completed → Generate Contract

### Filter Configuration
```
Label: Discovery Completed → Generate Contract
Condition: 1. Status = "Discovery Completed" OR 1. data.status = "Discovery Completed"
Fallback: No
```

### Module 3C: HTTP - Generate Contract
```
Method: POST
URL: https://zynra.studio/api/generate-contract
Headers:
  - Content-Type: application/json
Body Type: Raw
Content Type: JSON
Body:
{
  "leadData": {
    "clientName": "{{1.properties_value.Name[1].plain_text}}",
    "companyName": "{{1.properties_value.Company[1].plain_text}}",
    "projectName": "{{1.properties_value.Project Name[1].plain_text}}",
    "scopeSummary": "{{1.properties_value.Scope Summary[1].plain_text}}",
    "fee": {{1.properties_value.Fee}},
    "paymentTerms": "{{1.properties_value.Payment Terms.name}}",
    "startDate": "{{1.properties_value.Start Date}}"
  }
}
```

### Module 4C: Notion - Update Record
```
Module Type: Notion - Update a Data Source Item
Connection: [Your Notion Connection]
Update By: Data Source
Data Source ID: ce12e087-e701-4902-ae70-8ff582981d1b
Page ID: {{1.id}}
Fields:
  - Contract URL: {{3.Body.url}} (URL)
```

---

## Route 4: Contract Signed → Slack + Linear

### Filter Configuration
```
Label: Contract Signed → Slack + Linear
Condition: 1. Status = "Contract Signed" OR 1. data.status = "Contract Signed"
Fallback: No
```

### Module 3D: Slack - Create Channel
```
Module Type: Slack - Create a Channel
Connection: [Your Slack Connection]
Channel Name: {{replace(replace(lower(1.properties_value.Project Name[1].plain_text); " "; "-"); "[^a-z0-9-]"; "")}}
Is Private: No
Topic: Project: {{1.properties_value.Project Name[1].plain_text}}
```

### Module 4D: Slack - Invite Users
```
Module Type: Slack - Invite Users to Channel
Connection: [Your Slack Connection]
Channel: {{3.id}}
Users: [Add team member user IDs]
```

### Module 5D: Slack - Post Welcome Message
```
Module Type: Slack - Create a Message
Connection: [Your Slack Connection]
Channel: {{3.id}}
Text: [Load from templates/slack-welcome-message.md with variables replaced]
```

### Module 6D: Linear - Create Project (GraphQL)
```
Module Type: Linear - Execute a GraphQL Query
Connection: [Your Linear Connection]
Method: POST (queries and mutations)
Advanced Settings: ON
Operation Name: ProjectCreate
Variables Data Source: JSON
Variables:
{
  "input": {
    "name": "{{1.properties_value.Project Name[1].plain_text}}",
    "teamIds": ["YOUR_LINEAR_TEAM_ID"],
    "description": "Project for {{1.properties_value.Name[1].plain_text}}",
    "state": "planned"
  }
}
Query:
mutation ProjectCreate($input: ProjectCreateInput!) {
  projectCreate(input: $input) {
    success
    project {
      id
      name
      description
      url
    }
  }
}
```

### Module 7D-12D: Linear - Create Issues (6 issues)
```
Repeat 6 times for each issue:
- Kickoff & Onboarding
- Discovery Recap
- Milestone 1
- Milestone 2
- QA & Review
- Handover

Module Type: Linear - Create an Issue
Connection: [Your Linear Connection]
Team: [Your Linear Team ID]
Project: {{6.data.projectCreate.project.id}}
Title: [Issue Title]
Description: [Issue Description]
```

### Module 13D: Notion - Update Record
```
Module Type: Notion - Update a Data Source Item
Connection: [Your Notion Connection]
Update By: Data Source
Data Source ID: ce12e087-e701-4902-ae70-8ff582981d1b
Page ID: {{1.id}}
Fields:
  - Slack Channel URL: {{3.url}} (URL)
  - Linear Project URL: {{6.data.projectCreate.project.url}} (URL)
  - Linear Project ID: {{6.data.projectCreate.project.id}} (Text)
```

---

## Route 5: Deposit Paid → Activate Project

### Filter Configuration
```
Label: Deposit Paid → Activate Project
Condition: 1. Status = "Deposit Paid" OR 1. data.status = "Deposit Paid"
Fallback: No
```

### Module 3E: Linear - Update Project (GraphQL)
```
Module Type: Linear - Execute a GraphQL Query
Connection: [Your Linear Connection]
Method: POST (queries and mutations)
Advanced Settings: ON
Operation Name: ProjectUpdate
Variables Data Source: JSON
Variables:
{
  "id": "{{1.properties_value.Linear Project ID}}",
  "input": {
    "state": "started"
  }
}
Query:
mutation ProjectUpdate($id: String!, $input: ProjectUpdateInput!) {
  projectUpdate(id: $id, input: $input) {
    success
    project {
      id
      name
      state
      url
    }
  }
}
```

### Module 4E: Slack - Post Deposit Message
```
Module Type: Slack - Create a Message
Connection: [Your Slack Connection]
Channel: [Extract from {{1.properties_value.Slack Channel URL}}]
Text: [Load from templates/slack-deposit-received.md with variables]
```

### Module 5E: Notion - Update Record
```
Module Type: Notion - Update a Data Source Item
Connection: [Your Notion Connection]
Update By: Data Source
Data Source ID: ce12e087-e701-4902-ae70-8ff582981d1b
Page ID: {{1.id}}
Fields:
  - Status: In Progress (Select)
```

---

## Route 6: Review → Instructions

### Filter Configuration
```
Label: Review → Post Instructions
Condition: 1. Properties Value: Status = "Review"
Fallback: No
```

### Module 3F: Slack - Post Review Instructions
```
Module Type: Slack - Create a Message
Connection: [Your Slack Connection]
Channel: [Extract from {{1.properties_value.Slack Channel URL}}]
Text: [Load from templates/slack-review-instructions.md with variables]
```

### Module 4F: Linear - Update Issues (GraphQL)
```
Module Type: Linear - Execute a GraphQL Query
[Repeat for each issue or query all issues first]
Connection: [Your Linear Connection]
Method: POST (queries and mutations)
Advanced Settings: ON
Operation Name: IssueUpdate
Variables Data Source: JSON
Variables:
{
  "id": "[Issue ID]",
  "input": {
    "stateId": "[Review State ID]"
  }
}
Query:
mutation IssueUpdate($id: String!, $input: IssueUpdateInput!) {
  issueUpdate(id: $id, input: $input) {
    success
    issue {
      id
      title
      state {
        name
      }
    }
  }
}
```

---

## Route 7: Project Completion → Handover

### Filter Configuration
```
Label: Project Completion → Final Handover
Condition: 1. Status = "Project Completion" OR 1. data.status = "Project Completion"
Fallback: No
```

### Module 3G: Slack - Post Handover Message
```
Module Type: Slack - Create a Message
Connection: [Your Slack Connection]
Channel: [Extract from {{1.properties_value.Slack Channel URL}}]
Text: [Load from templates/slack-handover-message.md with variables]
Variables:
  - {{clientName}}: {{1.properties_value.Name[1].plain_text}}
  - {{projectName}}: {{1.properties_value.Project Name[1].plain_text}}
  - {{companyName}}: {{1.properties_value.Company[1].plain_text}}
  - {{completionDate}}: {{formatDate(now(); "MMMM DD, YYYY")}}
```

### Module 4G: Notion - Update Record
```
Module Type: Notion - Update a Data Source Item
Connection: [Your Notion Connection]
Update By: Data Source
Data Source ID: ce12e087-e701-4902-ae70-8ff582981d1b
Page ID: {{1.id}}
Fields:
  - [Any final status updates or archive flags]
```

---

## Property Mapping Reference

**IMPORTANT**: With custom webhook, the data structure is different from Notion module. Check Make.com webhook execution data to see exact paths.

### Status Property
```
{{1.status}} OR {{1.data.status}}
```

### Rich Text Properties
The polling service sends full Notion properties. Paths may vary:
```
{{1.properties.Name[0].plain_text}} OR {{1.data.properties.Name[0].plain_text}}
{{1.properties.Company[0].plain_text}} OR {{1.data.properties.Company[0].plain_text}}
{{1.properties.Project Name[0].plain_text}} OR {{1.data.properties.Project Name[0].plain_text}}
{{1.properties.Scope Summary[0].plain_text}} OR {{1.data.properties.Scope Summary[0].plain_text}}
{{1.properties.Message[0].plain_text}} OR {{1.data.properties.Message[0].plain_text}}
{{1.properties.Rejection Reason[0].plain_text}} OR {{1.data.properties.Rejection Reason[0].plain_text}}
```

**Note**: Array index may be `[0]` instead of `[1]` depending on Notion API response.

### Select Properties
```
{{1.properties.Status.select.name}} OR {{1.data.properties.Status.select.name}}
{{1.properties.Service.select.name}} OR {{1.data.properties.Service.select.name}}
{{1.properties.Payment Terms.select.name}} OR {{1.data.properties.Payment Terms.select.name}}
{{1.properties.Timeline.select.name}} OR {{1.data.properties.Timeline.select.name}}
{{1.properties.BudgetRange.select.name}} OR {{1.data.properties.BudgetRange.select.name}}
```

### Direct Access Properties
```
{{1.properties.Email.email}} OR {{1.data.properties.Email.email}}
{{1.properties.Phone.phone_number}} OR {{1.data.properties.Phone.phone_number}}
{{1.properties.Fee.number}} OR {{1.data.properties.Fee.number}}
{{1.properties.Start Date.date.start}} OR {{1.data.properties.Start Date.date.start}}
{{1.properties.Slack Channel URL.url}} OR {{1.data.properties.Slack Channel URL.url}}
{{1.properties.Linear Project URL.url}} OR {{1.data.properties.Linear Project URL.url}}
{{1.properties.Linear Project ID.rich_text[0].plain_text}} OR {{1.data.properties.Linear Project ID.rich_text[0].plain_text}}
{{1.properties.Contract URL.url}} OR {{1.data.properties.Contract URL.url}}
```

### Page ID
```
{{1.id}} OR {{1.data.id}}
```

**Debugging Tip**: After setting up the webhook, run a test execution and check the data structure in Make.com's execution history to see the exact paths.

---

## Testing Checklist

### Pre-Flight Checks
- [ ] All 3 API endpoints are deployed and working
- [ ] Notion integration has access to Leads & Email Templates databases
- [ ] Slack bot token configured with correct permissions
- [ ] Linear API key configured with correct team ID
- [ ] All template files exist and have correct variables

### Route Testing Order
1. [ ] Route 3: Discovery Completed (simplest, tests HTTP + Notion)
2. [ ] Route 1: Qualified (tests email draft creation)
3. [ ] Route 2: Unqualified (tests email draft creation)
4. [ ] Route 4: Contract Signed (most complex, tests Slack + Linear)
5. [ ] Route 5: Deposit Paid (tests Linear GraphQL updates)
6. [ ] Route 6: Review (tests issue updates)
7. [ ] Route 7: Project Completion (tests final handover)

### Per-Route Test Steps
1. Turn ON scenario in Make.com
2. Change lead status in Notion to test status
3. Verify webhook triggers within 1-2 seconds
4. Check Make.com execution history for success
5. Verify Notion fields updated correctly
6. Check Slack/Linear/Email as applicable

---

## Common Issues & Solutions

### Issue: Webhook not triggering
**Solution**: Re-save Module 1 to re-register webhook

### Issue: Route not executing
**Solution**: Check router filter condition spelling/capitalization

### Issue: Property mapping empty
**Solution**: Verify array indexing [1] and .plain_text/.name

### Issue: GraphQL mutation fails
**Solution**: Check variable types and format (JSON string)

### Issue: Slack channel not created
**Solution**: Verify bot permissions and channel name sanitization

---

## Maintenance Notes

### Monthly Tasks
- Review execution history for failures
- Update templates as needed
- Audit Notion database for data quality
- Check operation usage (should be lower than polling)

### When Adding New Status
1. Add new route to Router (Module 2)
2. Configure filter condition
3. Add necessary modules for new route
4. Test independently
5. Update this blueprint

---

## Related Documentation

- [Notion Webhook Setup Guide](NOTION_WEBHOOK_SETUP.md)
- [Gmail Draft Automation](make-scenarios/01-gmail-draft-automation.md)
- [Full Client Journey Automation](make-scenarios/02-full-client-journey-automation.md)
- [Quick Reference](QUICK_REFERENCE.md)
